# 第二次报告

## 我的任务：<u>中间代码的优化</u>

### 所做的：

1.选择优化方法，最后决定采用PPT上的DAG有向无环图对中间代码进行优化

2.DAG的数据结构设计，最后决定采用结构体来定义DAG图的节点，由节点集合组成的数组来表示DAG图

3.中间代码的基本块划分，采用判断四元式的操作符是否为入口或者出口判断，若为出口则直接划分，若为入口就回到上一个四元式在划分。并且第一个四元式规定是入口，最后一个四元式是出口。

4.构建DAG图进行优化并根据基本块内优化的DAG输出四元式（对DAG图的构建算法基      本参考第八章）

### 主要算法和数据结构

##### 1.数据结构

###### (1)首先是节点，采用结构体定义

struct newfour
{
  vector<string> idenchar;//副标识符 
  int node,parent;//图
  vector<int> children;
  token fuhao;//主标识符
  string nihao;//运算符号
};

###### (2)由节点数组组成的DAG图

vector<newfour> newfour1;

###### (3)输出的四元式

vector<fourarray> inoutfour;

###### (4)然后是从前端接收到的四元式定义方式

struct token
{
  char type;//类型
  string value;//值
};
vector<token> GT,CT,BT,JT,ST,cT;//关键字表 常数表 标识符表 界符表 字符串 字符
struct fourarray
{
  token name1,name2,name3,name4;//四元式
};
vector<fourarray> chararray;

##### 2.主要算法

​        主要根据第八章优化后面的PPT思路进行优化。

​        首先是四元式的划分，用两个BOOL函数判断操作符是否为入口和出口的标志或者cin和cout这些无法构成DAG节点的四元式，跳过这些四元式，剩下的就为+-*/=。

​        我们按照划分的顺序依次取出四元式，取出后先判断它的B,C节点是否存在，如果不存在那么先生成B,C节点，然后再按照操作符来进行分类。在构造DAG图时，根据操作符大致分为两类，一类为操作符为等号，一类为操作符不是等号，即为+-*/时。

​        如果是等于，那么先查找是否存在节点A并在附标记上，若有则将其从附标记删除，然后判断节点B是否存在，如果存在那么将A附加到B上并判断优先级调整位置，如果不存在那么添加B节点再进行附加。

​        如果操作符不是等于，那么我们先判断四元式的两个操作数是否全部为常数类型，如果均为常数，那么先计算出常数值，然后将四元式改为=形式再判断。如果不均为常数，先查找主标记是否存在于之前节点的附标记上，如果存在，那么将其删除。然后遍历之前的节点看是否由两个操作数与操作符一样的节点，如果有，那么将其附加到这个节点上，再判断优先级调整位置，若没有，那么定义节点A。

​       最后根据产生的一个个DAG图生成四元式。

### 问题

​        在四元式生成的过程中，如何跳过cin和cout这些既不是入口又不是出口的操作符，并将它们也顺序输出。另外，在后面的工作中，由于对结构体与算法的不熟悉，由组长赖煜华帮助完成了优化部分。这次编译原理实验中，我学到了很多，在写优化时总感觉了解了原理但是写不出来，深刻意识到自己的不足，在这里感谢组长和组员在课设时对我的帮助。

### 

